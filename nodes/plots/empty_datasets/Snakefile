import matplotlib
import matplotlib.pyplot as plt
import numpy as np
import os
import yaml
import numpy as np

TOKEN = config["token"]

rule all:
    input:
         config["png_out"]

rule count_non_empty_datasets:
    input:
         seq_based=config["sequence_based_encodings"],
         struc_based=config["structure_based_encodings"]
    output:
         f"data/temp/{TOKEN}/empty_datasets.yaml"
    run:
         def count_non_empty_files(ds, csv_paths):
             tmp = filter(lambda p: ds in p, csv_paths)
             return sum([1 if os.path.getsize(i) != 0 else 0 for i in tmp])

         count_data = {}
         for ds in config["datasets"]:
             count_data[ds] = \
                 {"seq_based": count_non_empty_files(ds, list(input.seq_based)),
                  "struc_based": count_non_empty_files(ds, list(input.struc_based))}

         with open(str(output), mode="w") as f:
             yaml.safe_dump(count_data, f)

rule plot:
    input:
         f"data/temp/{TOKEN}/empty_datasets.yaml"
    output:
         config["png_out"]
    run:
         with open(str(input)) as f:
             count_data = yaml.safe_load(f)

         labels = count_data.keys()
         count_seq_based_datasets = [count_data[ds]["seq_based"] for ds in count_data.keys()]
         count_struc_based_datasets = [count_data[ds]["struc_based"] for ds in count_data.keys()]

         x = np.arange(len(labels))  # the label locations
         width = 0.35  # the width of the bars

         fig, ax = plt.subplots()
         rects1 = ax.bar(x - width/2, count_seq_based_datasets, width, label="Sequence based")
         rects2 = ax.bar(x + width/2, count_struc_based_datasets, width, label="Structure based")

         ax.set_ylabel('Non-empty datasets')
         ax.set_title('Non-empty datasets by dataset and encoding type')
         ax.set_xticks(x)
         ax.set_xticklabels(labels, rotation=45)
         ax.legend()

         fig.tight_layout()
         plt.savefig(str(output))
